name: Recover SSH Key for Local Access

# 目的: ローカルの鍵を紛失した場合、GitHub Secrets に残っている鍵を使って
# 新しい鍵ペアを生成し、VPS に登録する。ローカルから SSH 接続できるようにする。
#
# 流れ:
# 1. 新しい鍵ペアを生成
# 2. Secrets の鍵で VPS に SSH し、新しい公開鍵を authorized_keys に追加
# 3. 新しい秘密鍵を Artifact として出力（ダウンロードしてローカルに保存）
#
# 実行後:
# - Artifact をダウンロード
# - 秘密鍵を ~/.ssh/id_ed25519 等に保存
# - chmod 600 ~/.ssh/id_ed25519
# - ssh -i ~/.ssh/id_ed25519 user@server で接続
#
# セキュリティ: ダウンロード後、このワークフローの Artifact を削除することを推奨

on:
  workflow_dispatch:

jobs:
  recover-key:
    runs-on: ubuntu-latest
    steps:
      - name: Generate new SSH key pair
        id: generate
        run: |
          ssh-keygen -t ed25519 -f key -N "" -C "recovered-for-local"
          echo "新しい鍵ペアを生成しました"
          # 公開鍵を output に格納（複数行対応）
          echo "public_key<<EOF" >> $GITHUB_OUTPUT
          cat key.pub >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add new public key to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          NEW_PUBLIC_KEY: ${{ steps.generate.outputs.public_key }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          envs: NEW_PUBLIC_KEY
          script: |
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            echo "$NEW_PUBLIC_KEY" >> ~/.ssh/authorized_keys
            chmod 600 ~/.ssh/authorized_keys
            echo "公開鍵を VPS に登録しました"

      - name: Upload private key as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ssh-private-key-recovered
          path: key
          retention-days: 1
